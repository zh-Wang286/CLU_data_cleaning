# Azure CLU 训练数据质量分析工具

本项目是一个自动化的数据质量分析工具，专门用于评估和优化 Azure Conversational Language Understanding (CLU) 的训练数据。它通过向量化技术和聚类分析，量化NLU意图（Intent）的语义质量，帮助开发者在模型训练前发现数据中存在的问题。

## 1. 项目环境与安装

本项目使用 [uv](https://github.com/astral-sh/uv) 作为推荐的包管理工具，以实现快速、可靠的环境搭建。

### 环境要求
- Python >= 3.10
- `uv` 包管理工具

### 安装步骤

1.  **创建虚拟环境**:
    ```bash
    uv venv
    ```

2.  **激活虚拟环境**:
    - **Linux/macOS**:
      ```bash
      source .venv/bin/activate
      ```
    - **Windows (PowerShell)**:
      ```powershell
      .venv\Scripts\Activate.ps1
      ```

3.  **安装依赖**:
    项目的所有依赖都定义在 `pyproject.toml` 文件中。使用以下命令进行安装：
    ```bash
    uv pip install .
    ```

## 2. 核心分析方法：HDBSCAN聚类

一个自动化的“归类”过程。

### 工作原理

HDBSCAN (Hierarchical Density-Based Spatial Clustering of Applications with Noise) 是一种基于密度的聚类算法，它在识别数据点集群时非常有效，尤其擅长处理噪声数据。

其核心思想是，一个“集群”（Cluster）是一个密度高于外部区域的数据点集合。算法的工作流程可以概括为：

1.  **定义空间和距离**: 将每一句 utterance 视为高维空间中的一个点。点与点之间的“距离”代表了它们语义上的相似度。距离越近，语义越相似。
2.  **识别核心点**: 算法会遍历所有数据点，找出那些在自己周围一个小半径内拥有足够多邻居的“核心点”。这些点位于密集区域的中心。
3.  **扩展集群**: 从核心点出发，算法开始向外扩展，将所有密度可达（即足够近）的点都合并到同一个集群中。
4.  **识别噪声**: 那些既不是核心点，也无法从任何核心点扩展到达的稀疏数据点，被认为是“噪声”（Noise），不属于任何集群。

**HDBSCAN的优势在于**：
-   它不需要预先设定要找几个集群（聚类数量）。
-   它可以识别出各种奇形怪状的星座（任意形状的聚类）。
-   它能自动把无关的“噪声”数据剔除出去。

**在本项目中的应用**：
我们对**同一个Intent内部**的所有utterances进行HDBSCAN聚类。理想情况下，一个定义良好的Intent，其内部所有utterances的语义应该高度一致，因此它们应该**只形成一个紧密的聚类**。

如果一个Intent内部的utterances分裂成了**多个聚类**，或者有**大量的噪声点**，这通常意味着该Intent的语义定义**过于宽泛**，可能包含了多个不同的用户意图，需要进行拆分或清洗。

## 3. 分析工作流

本工具的分析流程严谨且全面，主要包含以下几个阶段：

1.  **数据概览**:
    -   首先，程序会加载 `data/IT_01_1.json` 文件。
    -   统计并输出基本信息，包括Intent的总数和utterance的总数，让使用者对数据规模有一个宏观认识。

2.  **Intent间低耦合性分析 (Inter-Intent Coupling)**:
    -   **目标**: 确保**不同的Intent之间**语义区分度高，避免模棱两可。
    -   **方法**: 计算每一对Intent之间的平均语义相似度。
    -   **产出**: 识别出那些语义上过于接近、可能导致NLU模型混淆的Intent对。例如，"查询天气" 和 "今天天气怎么样" 这两个Intent就可能耦合度很高。

3.  **Intent内高内聚性分析 (Intra-Intent Cohesion)**:
    -   **目标**: 确保**同一个Intent内部**的所有utterances语义高度一致。
    -   **方法**: 对每个Intent内部的utterances应用HDBSCAN聚类算法。
    -   **产出**: 识别出那些内部语义不一致、可能需要被拆分的"宽泛"Intent。例如，一个名为"账户问题"的Intent，如果内部既包含了"忘记密码"，又包含了"修改手机号"，那么它很可能会分裂成多个聚类。

## 4. 如何解读输出结果

程序运行后，所有分析结果都会保存在 `output/` 目录下。

### 报告与数据文件

-   `analysis_report.md`: **（首要查看）** 一份Markdown格式的总结报告，用人类友好的方式概述了所有核心发现，是快速了解数据质量的入口。
-   `high_similarity_intents.csv`: 低耦合性分析的详细数据。列出了所有语义相似度超过阈值（默认为0.8）的Intent对，按相似度从高到低排序。
-   `intent_cohesion_metrics.csv`: 高内聚性分析的详细数据。为每个Intent提供了量化指标，如样本数、聚类数、噪声点比例等。

### 可视化图表

#### `intent_similarity_heatmap.png` (Intent相似度热力图)

-   **用途**: 宏观地展示所有Intent两两之间的语义相似度。
-   **如何解读**:
    -   **坐标轴**: X轴和Y轴都是项目中的Intent列表。
    -   **颜色**: 方格的颜色代表其对应的两个Intent的相似度。
        -   **暖色调 (红/黄)**: 代表**高相似度**。这是我们需要关注的区域，因为它意味着这两个不同的Intent在语义上可能过于接近，容易混淆。
        -   **冷色调 (蓝/绿)**: 代表**低相似度**。这是理想状态，说明这两个Intent有很好的区分度。
    -   **关注点**: 重点观察**非主对角线**上的**红色或黄色**方块。

#### `intent_cohesion_analysis.png` (Intent内聚性分析仪表盘)

-   **用途**: 包含四个子图，从不同维度展示所有Intent的内部质量。
-   **如何解读**:
    1.  **左上 - Clusters per Intent**: 理想情况下，绝大多数Intent都应该只有**1个**聚类。如果有很多Intent形成了2个或更多的聚类，说明数据中普遍存在"宽泛Intent"的问题。
    2.  **右上 - Noise Ratios**: 展示了被识别为"噪声"（即与核心语义不符）的utterance在每个Intent中所占的比例。某个Intent的噪声比例过高，说明其数据质量需要清洗。
    3.  **左下 - Silhouette Scores**: 这是一个衡量聚类效果的技术指标，分数越高代表聚类效果越好（内部越紧密，外部越疏离）。
    4.  **右下 - Sample Counts per Intent**: 展示每个Intent包含多少样本。可以帮助发现那些样本量过少、可能需要数据增强的Intent。

#### `intent_2d_visualization.png` & `intent_3d_visualization.png` (语义空间分布图)

-   **用途**: 将高维的语义向量降维到2D或3D平面上，让我们能“看见”每个utterance在语义空间中的位置。
-   **如何解读**:
    -   **点**: 图上的每一个点代表一句utterance。
    -   **颜色**: 不同的颜色代表不同的Intent。
    -   **理想状态**: 好的数据会呈现出**界限分明、颜色纯粹**的"色块"。每个色块内部紧密，色块之间距离远。
    -   **发现问题**:
        -   **耦合性问题**: 两个**不同颜色**的色块互相渗透、混杂在一起，说明这两个Intent语义重叠严重。
        -   **内聚性问题**: 一个**相同颜色**的色块分布得非常松散，甚至分裂成了几个互不相连的小块，说明这个Intent的定义过于宽泛。
